import Head from "next/head";
import { useEffect, useState } from "react";

import ListCard from "../../components/Manage/ListCard";
import PageTitle from "../../components/PageTitle";
import ListModel from "../../models/listModel";
import { useUser } from "@supabase/auth-helpers-react";
import ListsLoginAdvice from "../../components/Manage/ListsLoginAdvice";

import ListFinder from "../../components/Manage/ListFinder";
import NoListsMessage from "../../components/Manage/NoListsMessage";
import { useSelector } from "react-redux";
import DeleteListModal from "@/components/Modals/DeleteListModal";
import ListsCardsContainer from "@/components/ListDetails/ListsCardsContainer";
import StoreModel from "@/models/StoreModel";
import ModalPortal from "@/components/Modals/ModalPortal";

export default function Lists() {
   const user = useUser();
   const { lists } = useSelector((state: StoreModel) => state.lists);

   const [listToDelete, setListToDelete] = useState<ListModel | null>(null);

   const [isModalOpen, setIsModalOpen] = useState<boolean>(false);
   const openDeleteModal = (list: any) => {
      setIsModalOpen(true);
      setListToDelete(list);
   };
   const closeDeleteModal = () => {
      setIsModalOpen(false);
      setListToDelete(null);
   };
   const [inputValue, setInputValue] = useState<string>("");
   const [filteredLists, setFilteredLists] = useState<any[]>([]);
   useEffect(() => {
      const founded = lists.filter(({ name }) =>
         name.toLocaleLowerCase().includes(inputValue.toLocaleLowerCase())
      );
      setFilteredLists(founded);
   }, [inputValue, lists]);

   return (
      <div className="px-10 pb-10 overflow-hidden">
         <Head>
            <title>Manage Lists</title>
            <meta name="description" content="Generated by create next app" />
            <link rel="icon" href="/favicon.ico" />
         </Head>
         <div className="sm:flex w-full justify-between">
            <PageTitle>Manage</PageTitle>
            <div className="flex justify-end">
               <ListFinder
                  onChange={(e) => setInputValue(e.currentTarget.value)}
                  value={inputValue}
               />
            </div>
         </div>
         {user ? (
            <div>
               {filteredLists.length > 0 ? (
                  <ListsCardsContainer>
                     {filteredLists.map((list) => (
                        <ListCard
                           key={list.id}
                           list={list}
                           openDeleteModal={openDeleteModal}
                        />
                     ))}
                  </ListsCardsContainer>
               ) : (
                  <NoListsMessage />
               )}
            </div>
         ) : (
            <ListsLoginAdvice />
         )}

         <ModalPortal isOpen={isModalOpen}>
            <DeleteListModal
               close={closeDeleteModal}
               listToDelete={listToDelete}
            />
         </ModalPortal>
      </div>
   );
}
